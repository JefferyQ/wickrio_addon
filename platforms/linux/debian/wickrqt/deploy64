#!/bin/sh
# a second stage deploy script...
# Arguments to this script:

set -e
current=`dirname $0`
cd $current
current=$PWD

target=wickr-qt
baseversion=5.10
version=5.10.1
QTSRCDIR=/usr/local/wickr/Qt/5.10.1/gcc_64
QTDSTDIR=/usr/local/wickr/Qt-5.10

output_dir="$1"
if test -z "$output_dir" ; then
	output_dir="/dev/null" ; fi

prefix=~/tmp/${target}_${version}-deb
debian=~/tmp/${target}_${version}-deb/DEBIAN

libdir=${prefix}${QTDSTDIR}/lib
plugins=${prefix}${QTDSTDIR}/plugins
#qmldir=${prefix}${QTDSTDIR}/qml

echo $libdir

rm -rf $prefix
mkdir -p $debian
mkdir -p $libdir
mkdir -p $plugins
#mkdir -p $qmldir

sed -e "s/PACKAGE/${target}-${baseversion}/; s/VERSION/$version/" <./${target}.control64 >$debian/control


#
# cp -a $QTSRCDIR/lib/*.so $QTSRCDIR/lib/*.so.* $libdir/

cp -a $QTSRCDIR/lib/libQt5Core.* $libdir/
cp -a $QTSRCDIR/lib/libQt5DBus.* $libdir/
cp -a $QTSRCDIR/lib/libQt5Gui.* $libdir/
cp -a $QTSRCDIR/lib/libQt5NetworkAuth.* $libdir/
cp -a $QTSRCDIR/lib/libQt5Network.* $libdir/
cp -a $QTSRCDIR/lib/libQt5Sql.* $libdir/
cp -a $QTSRCDIR/lib/libQt5WebChannel.* $libdir/
cp -a $QTSRCDIR/lib/libQt5WebEngineCore.* $libdir/
cp -a $QTSRCDIR/lib/libQt5WebEngine.* $libdir/
cp -a $QTSRCDIR/lib/libQt5WebEngineWidgets.* $libdir/
cp -a $QTSRCDIR/lib/libQt5WebSockets.* $libdir/
cp -a $QTSRCDIR/lib/libQt5Widgets.* $libdir/
cp -a $QTSRCDIR/lib/libicu* $libdir/

cp -a $QTSRCDIR/plugins/* $plugins/
#cp -a $QTSRCDIR/qml/* $qmldir

cd $prefix
find . -type f ! -regex '.*?debian-binary.*' ! -regex '.*?DEBIAN.*' -printf '%P ' | xargs md5sum > DEBIAN/md5sums

cd ~/tmp
chmod 0644 $debian/*
chmod -R g-w $prefix/usr
chmod -x $libdir/*.so*
rm -f ${target}_*.deb
fakeroot chown -R root:root $prefix
fakeroot dpkg -b ${target}_${version}-deb/ ${target}_${version}_amd64.deb
sha256sum ${target}_${version}_amd64.deb >${target}_${version}_amd64.deb.sha256
if test -d "$output_dir" ; then
	cp ${target}_${version}_amd64.* "$output_dir/" ; fi

