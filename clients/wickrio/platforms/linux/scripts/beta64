#!/bin/sh

# a second stage deploy script...

set -e
current=`dirname $0`
cd $current

QTVER="5_6_1"
if test -z "$QTDIR" ; then
	QTDIR=`echo ~/Qt*/5.6/gcc_64`
	QTVER="5_6_1"
fi

#
# Setup the version number(s)
#
maj=`cat ../../../OFFICIAL_BUILD_VERSION | cut -c1-1`
min=`cat ../../../OFFICIAL_BUILD_VERSION | cut -c2-2`
pat=`cat ../../../OFFICIAL_BUILD_VERSION | cut -c3-3`
bld=`cat ../../../OFFICIAL_BUILD_NUMBER | cut -c4-6`

version="${maj}.${min}.${pat}-${bld}~beta"

echo "Version=$version"

prefix=~/tmp/wickrio-beta-deb
debian=~/tmp/wickrio-beta-deb/DEBIAN
bindir=$prefix/usr/bin
sbindir=$prefix/usr/sbin
libdir=$prefix/usr/lib/wickrio-beta
docdir=$prefix/usr/share/doc/wickrio-beta
plugins=$prefix/usr/lib/wickrio-beta/plugins

# Service related definitions
svcinitdir=$prefix/etc/init.d

optdir=$prefix/opt/WickrIOBeta
scriptsdir=$optdir/scripts
imagedir=$optdir/attachments/image

platform=$current/../../../../../platforms/linux/generic-64
support=$current/../support

# Client definitions
menus=$prefix/usr/share/applications
pixmaps=$prefix/usr/share/pixmaps
messages=$prefix/usr/share/indicators/messages/applications
appdata=$prefix/usr/share/appdata

# Cleanup the target location (i.e. remove the target directory)
rm -rf $prefix

# Create the appropriate directories in the target location
mkdir -p $debian
mkdir -p $bindir
mkdir -p $sbindir
mkdir -p $docdir
mkdir -p $libdir
mkdir -p $optdir
mkdir -p $scriptsdir
mkdir -p $imagedir
#mkdir -p $crondir
mkdir -p $plugins/sqldrivers
mkdir -p $svcinitdir

# Client directories
mkdir -p $pixmaps
mkdir -p $menus
mkdir -p $appdata

#
# Copy the executables
#
cp -a $current/../../../../../../build-bots-Desktop_Qt_${QTVER}_GCC_64bit-Debug/bots/wickrio/settings_init/wickrbot_settings_init $bindir/wickrbot_settings_init-beta
cp -a $current/../../../../../../build-bots-Desktop_Qt_${QTVER}_GCC_64bit-Debug/bots/wickrio/service_control/wickrio_service_control $bindir/wickrio_service_control-beta
#cp -a $current/../../../../../../build-bots-Desktop_Qt_${QTVER}_GCC_64bit-Debug/bots/wickrio/client/WickrIOClientBeta $bindir
cp -a $current/../../../../../../build-bots-Desktop_Qt_${QTVER}_GCC_64bit-Debug/bots/wickrio/enterpriseclient/WickrIOEClientBeta $bindir
cp -a $current/../../../../../../build-bots-Desktop_Qt_${QTVER}_GCC_64bit-Debug/bots/wickrio/console/WickrIOConsoleBeta $bindir
cp -a $current/../../../../../../build-bots-Desktop_Qt_${QTVER}_GCC_64bit-Debug/bots/wickrio/consoleserver/WickrIOCSvrBeta $sbindir
cp -a $current/../../../../../../build-bots-Desktop_Qt_${QTVER}_GCC_64bit-Debug/bots/wickrio/clientserver/WickrIOSvrBeta $sbindir

# only for Beta version
cp -a $current/../../../../../../build-bots-Desktop_Qt_${QTVER}_GCC_64bit-Debug/bots/wickrio/callback_listener/WickrIOCallbackListenerBeta $bindir

cp -a $current/../../../../../../build-bots-Desktop_Qt_${QTVER}_GCC_64bit-Debug/libs/qamqpsrc/libqamqp.* $libdir
cp -a $current/../../../../../../build-bots-Desktop_Qt_${QTVER}_GCC_64bit-Debug/libs/QtWebApp/libQtWebAppd.* $libdir
cp -a $current/../../../../../../build-bots-Desktop_Qt_${QTVER}_GCC_64bit-Debug/libs/WickrBot/libWickrBotd.* $libdir
cp -a $current/../../../../../../build-bots-Desktop_Qt_${QTVER}_GCC_64bit-Debug/libs/WickrBotGUI/libWickrBotGUId.* $libdir
cp -a $current/../../../../../../build-bots-Desktop_Qt_${QTVER}_GCC_64bit-Debug/libs/SMTPEmail/libSMTPEmail.* $libdir

chrpath -r /usr/lib/wickrio-beta $bindir/wickrio_service_control-beta
chrpath -r /usr/lib/wickrio-beta $bindir/wickrbot_settings_init-beta
#chrpath -r /usr/lib/wickrio-beta $bindir/WickrIOClientBeta
chrpath -r /usr/lib/wickrio-beta $bindir/WickrIOEClientBeta
chrpath -r /usr/lib/wickrio-beta $bindir/WickrIOConsoleBeta
chrpath -r /usr/lib/wickrio-beta $sbindir/WickrIOSvrBeta
chrpath -r /usr/lib/wickrio-beta $sbindir/WickrIOCSvrBeta

# only for Beta version
chrpath -r /usr/lib/wickrio-beta $bindir/WickrIOCallbackListenerBeta

#
# Copy support files.
# Change the contents appropriately for Beta version Release versions
#
sed -e "s/EXTENSION/-beta/g" -e "s/INSTALLEXT/Beta/g" -e "s/VERSION/$version/" <$current/control64 > $debian/control

# Installer pre and post installation scripts
sed -e "s/EXTENSION/-beta/g" -e "s/INSTALLEXT/Beta/g" <$current/preinst > $debian/preinst
sed -e "s/EXTENSION/-beta/g" -e "s/INSTALLEXT/Beta/g" <$current/postinst > $debian/postinst
sed -e "s/EXTENSION/-beta/g" -e "s/INSTALLEXT/Beta/g" <$current/prerm > $debian/prerm

# WickrIO Client Server settings file
sed -e "s/EXTENSION/-beta/g" -e "s/INSTALLEXT/Beta/g" <$current/WickrIOSvr.ini > $optdir/WickrIOSvrBeta.ini

# Daemon init script
sed -e "s/EXTENSION/-beta/g" -e "s/INSTALLEXT/Beta/g" <$current/WickrIOSvr.script > $svcinitdir/WickrIOSvrBeta

# Daemon init script
sed -e "s/EXTENSION/-beta/g" -e "s/INSTALLEXT/Beta/g" <$current/WickrIOCSvr.script > $svcinitdir/WickrIOCSvrBeta

#
# Copy the library files
#
cp -a $platform/*.so $platform/*.so.* $libdir/
cp -a $QTDIR/lib/*.so $QTDIR/lib/*.so.* $libdir/
cp -a $QTDIR/plugins/* $plugins/
rm -f $plugins/sqldrivers/*
#cp -a $current/../../../../../platforms/linux/plugins-64/* $plugins/sqldrivers/
cp -a $current/../plugins-64/* $plugins/sqldrivers/
cp -a $QTDIR/libexec/* $libdir/
#cp -a $QTDIR/icudtl.dat $libdir/
cp -a $QTDIR/resources/icudtl.dat $libdir/
cp -Lp /usr/lib/x86_64-linux-gnu/libicu*.so.52 $libdir/
mkdir -p $messages
echo "/usr/share/applications/wickrio-beta.client" >$messages/wickrio-beta

#
# Generate the MD5 SUM value
#
cd $prefix
find . -type f ! -regex '.*?debian-binary.*' ! -regex '.*?DEBIAN.*' -printf '%P ' | xargs md5sum > DEBIAN/md5sums

#
# Change the mode of the installed files
#
cd ~/tmp
chmod 0644 $debian/*
chmod -R g-w $prefix/usr
chmod -x $libdir/*.so*
chmod 755 $debian/preinst
chmod 755 $debian/postinst
chmod 755 $debian/prerm
chmod 755 $svcinitdir/WickrIOSvrBeta
chmod 755 $svcinitdir/WickrIOCSvrBeta
chmod 644 $optdir/WickrIOSvrBeta.ini

#
# Create the actual package
#
rm -f wickrio-beta_*.deb
fakeroot chown -R root:root $prefix
chmod 4755 $bindir/WickrIOConsoleBeta

fakeroot dpkg -b wickrio-beta-deb/ wickrio-beta_${version}_amd64.deb
if [ "`basename $0`" = "deploy64" ]
then
  sha256sum wickrio_${version}_amd64.deb >wickrio-${version}.amd64.sha256
fi
