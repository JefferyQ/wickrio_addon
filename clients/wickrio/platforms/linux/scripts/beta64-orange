#!/bin/sh

# a second stage deploy script...

set -e
current=`dirname $0`
cd $current

QTVER="5_6_1"
if test -z "$QTDIR" ; then
	QTDIR=`echo ~/Qt*/5.6/gcc_64`
	QTVER="5_6_1"
fi

#
# Setup the version number(s)
#
maj=`cat ../../../OFFICIAL_BUILD_VERSION | cut -c1-1`
min=`cat ../../../OFFICIAL_BUILD_VERSION | cut -c2-2`
pat=`cat ../../../OFFICIAL_BUILD_VERSION | cut -c3-3`
bld=`cat ../../../OFFICIAL_BUILD_NUMBER | cut -c4-6`

BLDTYPE="Debug"
bldtype=alpha
BldType=Alpha

version="${maj}.${min}.${pat}-${bld}~${bldtype}"

echo "Version=$version"

prefix=~/tmp/wickrio-${bldtype}-deb
debian=~/tmp/wickrio-${bldtype}-deb/DEBIAN
bindir=$prefix/usr/bin
sbindir=$prefix/usr/sbin
libdir=$prefix/usr/lib/wickrio-${bldtype}
docdir=$prefix/usr/share/doc/wickrio-${bldtype}
plugins=$prefix/usr/lib/wickrio-${bldtype}/plugins

# Service related definitions
svcinitdir=$prefix/etc/init.d

optdir=$prefix/opt/WickrIO$BldType
scriptsdir=$optdir/scripts
imagedir=$optdir/attachments/image

platform=$current/../../../../../platforms/linux/generic-64
support=$current/../support

# Client definitions
menus=$prefix/usr/share/applications
pixmaps=$prefix/usr/share/pixmaps
messages=$prefix/usr/share/indicators/messages/applications
appdata=$prefix/usr/share/appdata

# Cleanup the target location (i.e. remove the target directory)
rm -rf $prefix

# Create the appropriate directories in the target location
mkdir -p $debian
mkdir -p $bindir
mkdir -p $sbindir
mkdir -p $docdir
mkdir -p $libdir
mkdir -p $optdir
mkdir -p $scriptsdir
mkdir -p $imagedir
#mkdir -p $crondir
mkdir -p $plugins/sqldrivers
mkdir -p $svcinitdir

# Client directories
mkdir -p $pixmaps
mkdir -p $menus
mkdir -p $appdata

#
# Copy the executables
#
cp -a $current/../../../../../../build-bots-Desktop_Qt_${QTVER}_GCC_64bit-${BLDTYPE}/bots/wickrio/settings_init/wickrbot_settings_init $bindir/wickrbot_settings_init-${bldtype}
cp -a $current/../../../../../../build-bots-Desktop_Qt_${QTVER}_GCC_64bit-${BLDTYPE}/bots/wickrio/service_control/wickrio_service_control $bindir/wickrio_service_control-${bldtype}
#cp -a $current/../../../../../../build-bots-Desktop_Qt_${QTVER}_GCC_64bit-${BLDTYPE}/bots/wickrio/client/WickrIOClient$BldType $bindir
cp -a $current/../../../../../../build-bots-Desktop_Qt_${QTVER}_GCC_64bit-${BLDTYPE}/bots/wickrio/enterpriseclient/WickrIOEClient$BldType $bindir
cp -a $current/../../../../../../build-bots-Desktop_Qt_${QTVER}_GCC_64bit-${BLDTYPE}/bots/wickrio/console/WickrIOConsole$BldType $bindir
cp -a $current/../../../../../../build-bots-Desktop_Qt_${QTVER}_GCC_64bit-${BLDTYPE}/bots/wickrio/consoleserver/WickrIOCSvr$BldType $sbindir
cp -a $current/../../../../../../build-bots-Desktop_Qt_${QTVER}_GCC_64bit-${BLDTYPE}/bots/wickrio/clientserver/WickrIOSvr$BldType $sbindir

# only for Beta version
cp -a $current/../../../../../../build-bots-Desktop_Qt_${QTVER}_GCC_64bit-${BLDTYPE}/bots/wickrio/callback_listener/WickrIOCallbackListener$BldType $bindir

cp -a $current/../../../../../../build-bots-Desktop_Qt_${QTVER}_GCC_64bit-${BLDTYPE}/libs/qamqpsrc/libqamqp.* $libdir
cp -a $current/../../../../../../build-bots-Desktop_Qt_${QTVER}_GCC_64bit-${BLDTYPE}/libs/QtWebApp/libQtWebAppd.* $libdir
cp -a $current/../../../../../../build-bots-Desktop_Qt_${QTVER}_GCC_64bit-${BLDTYPE}/libs/WickrBot/libWickrBotd.* $libdir
cp -a $current/../../../../../../build-bots-Desktop_Qt_${QTVER}_GCC_64bit-${BLDTYPE}/libs/WickrBotGUI/libWickrBotGUId.* $libdir
cp -a $current/../../../../../../build-bots-Desktop_Qt_${QTVER}_GCC_64bit-${BLDTYPE}/libs/SMTPEmail/libSMTPEmail.* $libdir

chrpath -r /usr/lib/wickrio-${bldtype} $bindir/wickrio_service_control-${bldtype}
chrpath -r /usr/lib/wickrio-${bldtype} $bindir/wickrbot_settings_init-${bldtype}
#chrpath -r /usr/lib/wickrio-${bldtype} $bindir/WickrIOClient$BldType
chrpath -r /usr/lib/wickrio-${bldtype} $bindir/WickrIOEClient$BldType
chrpath -r /usr/lib/wickrio-${bldtype} $bindir/WickrIOConsole$BldType
chrpath -r /usr/lib/wickrio-${bldtype} $sbindir/WickrIOSvr$BldType
chrpath -r /usr/lib/wickrio-${bldtype} $sbindir/WickrIOCSvr$BldType

# only for Beta version
chrpath -r /usr/lib/wickrio-${bldtype} $bindir/WickrIOCallbackListener$BldType

#
# Copy support files.
# Change the contents appropriately for Beta version Release versions
#
sed -e "s/EXTENSION/-${bldtype}/g" -e "s/INSTALLEXT/${BldType}/g" -e "s/VERSION/$version/" <$current/control64 > $debian/control

# Installer pre and post installation scripts
sed -e "s/EXTENSION/-${bldtype}/g" -e "s/INSTALLEXT/${BldType}/g" <$current/preinst > $debian/preinst
sed -e "s/EXTENSION/-${bldtype}/g" -e "s/INSTALLEXT/${BldType}/g" <$current/postinst > $debian/postinst
sed -e "s/EXTENSION/-${bldtype}/g" -e "s/INSTALLEXT/${BldType}/g" <$current/prerm > $debian/prerm

# WickrIO Client Server settings file
sed -e "s/EXTENSION/-${bldtype}/g" -e "s/INSTALLEXT/${BldType}/g" <$current/WickrIOSvr.ini > $optdir/WickrIOSvr$BldType.ini

# Daemon init script
sed -e "s/EXTENSION/-${bldtype}/g" -e "s/INSTALLEXT/${BldType}/g" <$current/WickrIOSvr.script > $svcinitdir/WickrIOSvr$BldType

# Daemon init script
sed -e "s/EXTENSION/-${bldtype}/g" -e "s/INSTALLEXT/${BldType}/g" <$current/WickrIOCSvr.script > $svcinitdir/WickrIOCSvr$BldType

#
# Copy the library files
#
cp -a $platform/*.so $platform/*.so.* $libdir/
cp -a $QTDIR/lib/*.so $QTDIR/lib/*.so.* $libdir/
cp -a $QTDIR/plugins/* $plugins/
rm -f $plugins/sqldrivers/*
#cp -a $current/../../../../../platforms/linux/plugins-64/* $plugins/sqldrivers/
cp -a $current/../plugins-64/* $plugins/sqldrivers/
cp -a $QTDIR/libexec/* $libdir/
#cp -a $QTDIR/icudtl.dat $libdir/
cp -a $QTDIR/resources/icudtl.dat $libdir/
cp -Lp /usr/lib/x86_64-linux-gnu/libicu*.so.52 $libdir/
mkdir -p $messages
echo "/usr/share/applications/wickrio-${bldtype}.client" >$messages/wickrio-${bldtype}

#
# Generate the MD5 SUM value
#
cd $prefix
find . -type f ! -regex '.*?debian-binary.*' ! -regex '.*?DEBIAN.*' -printf '%P ' | xargs md5sum > DEBIAN/md5sums

#
# Change the mode of the installed files
#
cd ~/tmp
chmod 0644 $debian/*
chmod -R g-w $prefix/usr
chmod -x $libdir/*.so*
chmod 755 $debian/preinst
chmod 755 $debian/postinst
chmod 755 $debian/prerm
chmod 755 $svcinitdir/WickrIOSvr$BldType
chmod 755 $svcinitdir/WickrIOCSvr$BldType
chmod 644 $optdir/WickrIOSvr$BldType.ini

#
# Create the actual package
#
rm -f wickrio-${bldtype}_*.deb
fakeroot chown -R root:root $prefix
chmod 4755 $bindir/WickrIOConsole$BldType

fakeroot dpkg -b wickrio-${bldtype}-deb/ wickrio-${bldtype}_${version}_amd64.deb
if [ "`basename $0`" = "deploy64" ]
then
  sha256sum wickrio_${version}_amd64.deb >wickrio-${version}.amd64.sha256
fi
