#!/bin/bash

if [[ $# -eq 7 ]]
then
  qtdebfile=$1
  consoledebfile=$2
  botdebfile=$3
  botexe=$4
  dockerImage="wickr/$5"
  dockerService="wickrio-$5"
  dockerTag=$6
  integrationdebfile="$7"
  isWickrBot="false"
elif [[ $# -eq 9 ]]
then
  qtdebfile=$1
  consoledebfile=$2
  botdebfile=$3
  botexe=$4
  dockerImage="wickr/$5"
  dockerService="wickrio-$5"
  dockerTag=$6
  integrationdebfile="$7"
  coredebfile=$8
  servicedebfile=$9
  isWickrBot="true"
else
  FileName=`basename $0`
  echo "usage: $FileName <WickrQT> <console deb> <bot deb> <bot binary> <docker image> <image tag> <integration deb> [<core deb> <service deb>]"
  exit 1
fi

set -e
current=`dirname $0`
cd $current
set +e


echo ""
echo "********************************************************************"
echo "** Beginning to create docker image:"
echo "**   botexe=$botexe"
echo "**   dockerImage=$dockerImage"
echo "**   dockerService=$dockerService"
echo "**   dockerTag=$dockerTag"
echo "**   integrationDebFile=$integrationdebfile"
if [ "$isWickrBot" == "true" ] ; then
  echo "**   coredebfile=$coredebfile"
  echo "**   servicedebfile=$servicedebfile"
fi

#
# set the values within the Dockerfile and the start.sh
#
if [ "$isWickrBot" == "true" ] ; then
  sed -e "s/QTDEBFILE/${qtdebfile}/g" -e "s/BOTDEBFILE/${botdebfile}/g" -e "s/CONSOLEDEBFILE/${consoledebfile}/g" -e "s/INTEGRATIONDEBFILE/${consoledebfile}/g" -e "s/COREDEBFILE/${coredebfile}/g" -e "s/SERVICEDEBFILE/${servicedebfile}/g" <$current/Dockerfile.wickrbot.orig > $current/Dockerfile
else
  sed -e "s/QTDEBFILE/${qtdebfile}/g" -e "s/BOTDEBFILE/${botdebfile}/g" -e "s/CONSOLEDEBFILE/${consoledebfile}/g" -e "s/INTEGRATIONDEBFILE/${consoledebfile}/g" <$current/Dockerfile.orig > $current/Dockerfile
fi
sed -e "s/BOTEXECUTABLE/${botexe}/g" <$current/start.sh.orig > $current/start.sh
chmod 777 $current/start.sh

#
# docker-compose build, tag, and push image to docker hub
#
docker-compose -f build.docker build ${dockerService}
docker tag "$dockerImage" "${dockerImage}:${dockerTag}"
docker push "${dockerImage}:${dockerTag}"
docker rmi "${dockerImage}:${dockerTag}"
docker system prune -a -f

echo "** Finished creating docker image: ${dockerImage}:${dockerTag}"
echo "********************************************************************"
