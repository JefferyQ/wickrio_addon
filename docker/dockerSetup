#!/bin/bash

if [[ $# -ne 7 ]]
then
  FileName=`basename $0`
  echo "usage: $FileName <deb location> <WickrQT> <console deb> <bot deb> <bot binary> <docker image> <image tag>"
  exit 1
fi

set -e
current=`dirname $0`
cd $current
set +e

debDirectory=$1
qtdebfile=$2
consoledebfile=$3
botdebfile=$4
botexe=$5
dockerImage="wickr/$6"
dockerService="wickrio-$6"
dockerTag=$7

echo "********************************************************************"
echo "Beginning to create docker image:
echo "  botexe=$botexe
echo "  dockerImage=$dockerImage"
echo "  dockerService=$dockerService"
echo "  dockerTag=$dockerTag"

#
# set the values within the Dockerfile and the start.sh
#
sed -e "s:DEBDIRECTORY:${debDirectory}:g" -e "s/QTDEBFILE/${qtdebfile}/g" -e "s/BOTDEBFILE/${botdebfile}/g" -e "s/CONSOLEDEBFILE/${consoledebfile}/g" <$current/Dockerfile.orig > $current/Dockerfile
sed -e "s/BOTEXECUTABLE/${botexe}/g" <$current/start.sh.orig > $current/start.sh

#
# docker-compose build, tag, and push image to docker hub
#
docker-compose -f build.docker build ${dockerService}
docker tag "$dockerImage" "${dockerImage}:${dockerTag}"
docker push "${dockerImage}:${dockerTag}"
docker rmi "${dockerImage}:${dockerTag}"

echo "Finished creating docker image"
echo "********************************************************************"
