#!/bin/bash

if [[ $# -eq 7 ]]
then
  qtdebfile=$1
  consoledebfile=$2
  botdebfile=$3
  botexe=$4
  dockerImage="wickr/$5"
  dockerService="wickrio-$5"
  dockerTag=$6
  integrationdebfile="$7"
  isWickrBot="false"
elif [[ $# -eq 5 ]]
then
  qtdebfile=$1
  botdebfile=$2
  botexe=$3
  dockerImage="wickr/$4"
  dockerService="wickrio-$4"
  dockerTag=$5
  isWickrBot="true"
else
  FileName=`basename $0`
  echo "usage: for WickrIO Bots"
  echo "$FileName <WickrQT> <bot deb> <bot binary> <docker image> <image tag>"
  echo "usage: for other Bots"
  echo "$FileName <WickrQT> <console> <bot deb> <bot binary> <docker image> <image tag> <integration deb>"
  exit 1
fi

set -e
current=`dirname $0`
cd $current
set +e


echo ""
echo "********************************************************************"
echo "** Beginning to create docker image:"
if [ "$isWickrBot" == "true" ] ; then
  echo "**   botexe=$botexe"
  echo "**   botdebfile=$debfile"
  echo "**   dockerImage=$dockerImage"
  echo "**   dockerService=$dockerService"
  echo "**   dockerTag=$dockerTag"
else
  echo "**   botexe=$botexe"
  echo "**   botdebfile=$debfile"
  echo "**   consoledebfile=$consoledebfile"
  echo "**   dockerImage=$dockerImage"
  echo "**   dockerService=$dockerService"
  echo "**   dockerTag=$dockerTag"
  echo "**   integrationDebFile=$integrationdebfile"
fi

#
# set the values within the Dockerfile and the start.sh
#
if [ "$isWickrBot" == "true" ] ; then
  sed -e "s/QTDEBFILE/${qtdebfile}/g" -e "s/DOCKERDEBFILE/${botdebfile}/g" <$current/Dockerfile.wickrbot.orig > $current/Dockerfile
else
  sed -e "s/QTDEBFILE/${qtdebfile}/g" -e "s/BOTDEBFILE/${botdebfile}/g" -e "s/CONSOLEDEBFILE/${consoledebfile}/g" -e "s/INTEGRATIONDEBFILE/${integrationdebfile}/g" <$current/Dockerfile.orig > $current/Dockerfile
fi
sed -e "s/BOTEXECUTABLE/${botexe}/g" <$current/start.sh.orig > $current/start.sh
chmod 777 $current/start.sh

#
# docker-compose build, tag, and push image to docker hub
#
docker-compose -f build.docker build ${dockerService}
docker tag "$dockerImage" "${dockerImage}:${dockerTag}"
docker push "${dockerImage}:${dockerTag}"
docker rmi "${dockerImage}:${dockerTag}"
docker system prune -a -f

echo "** Finished creating docker image: ${dockerImage}:${dockerTag}"
echo "********************************************************************"
